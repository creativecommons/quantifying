# Build stage
FROM python:3.11-slim AS builder

WORKDIR /build

# Upgrade pip and install build dependencies
RUN python -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Copy only the requirements for this stage
COPY docker/2-process/requirements.txt .

# Install only the required packages
RUN pip install --no-cache-dir -r requirements.txt

# Runtime stage
FROM python:3.11-slim

WORKDIR /app

# Install only git (required runtime dependency)
RUN apt-get update && \
    apt-get install -y --no-install-recommends git && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -m -u 1002 quantify && \
    mkdir -p /app/data && \
    chown -R quantify:quantify /app

# Copy only the installed packages and specific scripts needed
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY scripts/shared.py ./scripts/
COPY scripts/plot.py ./scripts/
COPY scripts/2-process/gcs_process.py ./scripts/2-process/

USER quantify

ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

ENTRYPOINT ["python", "scripts/2-process/gcs_process.py"]
CMD []
